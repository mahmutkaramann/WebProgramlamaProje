@{
    ViewData["Title"] = "Tarih ve Saat Seçimi";
    var antrenor = ViewBag.Antrenor as YeniSalon.Models.Antrenor;
    var hizmet = ViewBag.Hizmet as YeniSalon.Models.Hizmet;
    var availableDates = ViewBag.AvailableDates as List<YeniSalon.Controllers.AvailableDateViewModel>;
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="text-center">Yeni Randevu - 2. Adım: Tarih ve Saat Seçimi</h3>
                </div>
                <div class="card-body">
                    <!-- Seçilen Bilgiler Özeti -->
                    <div class="alert alert-info mb-4">
                        <h5>Seçiminiz:</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Antrenör:</strong> @antrenor?.Ad @antrenor?.Soyad</p>
                                <p><strong>Uzmanlık:</strong> @antrenor?.UzmanlikAlanlari</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Hizmet:</strong> @hizmet?.HizmetAdi</p>
                                <p><strong>Süre:</strong> @hizmet?.SureDakika dakika</p>
                                <p><strong>Fiyat:</strong> @hizmet?.Ucret.ToString("C2")</p>
                            </div>
                        </div>
                    </div>

                    @if (availableDates == null || !availableDates.Any())
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Bu antrenör için önümüzdeki 14 günde müsait saat bulunmamaktadır.
                            <a href="@Url.Action("Create", "UyeRandevu")" class="btn btn-outline-warning btn-sm ms-2">
                                <i class="fas fa-arrow-left"></i> Farklı Antrenör Seç
                            </a>
                        </div>
                    }
                    else
                    {
                        <h5 class="mb-3">Müsait Tarih ve Saatler:</h5>

                        <!-- DROPDOWN ile Tarih Seçimi -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Tarih Seçin:</label>
                                <select class="form-select" id="dateSelect">
                                    <option value="">Tarih Seçiniz</option>
                                    @foreach (var date in availableDates)
                                    {
                                        <option value="@date.Date.ToString("yyyy-MM-dd")" data-day="@date.DayName">
                                            @date.DayName, @date.Date.ToString("dd.MM.yyyy")
                                        </option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Saat Seçin:</label>
                                <select class="form-select" id="timeSelect" disabled>
                                    <option value="">Önce tarih seçin</option>
                                </select>
                            </div>
                        </div>

                        <!-- Seçilen Tarih Gösterimi -->
                        <div class="alert alert-secondary mb-4">
                            <h6>Seçiminiz:</h6>
                            <p id="selectedDateTimeText">Henüz tarih/saat seçmediniz</p>
                        </div>

                        <!-- Müsaitlik Kontrolü -->
                        <div class="mb-4">
                            <button type="button" id="checkAvailability" class="btn btn-outline-info w-100">
                                <i class="fas fa-search"></i> Müsaitlik Kontrol Et
                            </button>
                            <div id="availabilityResult" class="alert d-none mt-2"></div>
                        </div>

                        <!-- Not Alanı -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Not (İsteğe bağlı):</label>
                            <textarea class="form-control" id="not" rows="3" placeholder="Randevu için özel notunuz..."></textarea>
                        </div>

                        <!-- DEVAM ET BUTONU - HER ZAMAN GÖRÜNÜR -->
                        <div class="mb-4">
                            <button type="button" id="continueButton" class="btn btn-success btn-lg w-100" disabled>
                                <i class="fas fa-check"></i> DEVAM ET - Randevu Talebini Oluştur
                            </button>
                        </div>

                        <!-- Geri Dön Butonu -->
                        <div class="text-center">
                            <a href="@Url.Action("Create", "UyeRandevu")" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Geri Dön (Antrenör/Hizmet Değiştir)
                            </a>
                        </div>

                        <!-- Gizli Form -->
                        <form id="appointmentForm" method="post" action="@Url.Action("CreateAppointment", "UyeRandevu")" style="display: none;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="AntrenorId" value="@ViewBag.AntrenorId" />
                            <input type="hidden" name="HizmetId" value="@ViewBag.HizmetId" />
                            <input type="hidden" name="RandevuTarihi" id="formDateTime" />
                            <input type="hidden" name="DurationMinutes" value="@hizmet?.SureDakika" />
                            <input type="hidden" name="Not" id="formNot" />
                        </form>
                    }
                </div>
            </div>

            <!-- Bilgilendirme -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5><i class="fas fa-info-circle text-primary"></i> Bilgilendirme:</h5>
                    <ul class="mb-0">
                        <li>Randevular antrenör onayından sonra kesinleşir</li>
                        <li>Randevu saatinden 15 dakika önce salonda olunuz</li>
                        <li>İptaller için en az 2 saat önce bildirim yapınız</li>
                        <li>Randevu saatinizden 1 saat önce hatırlatma mesajı alacaksınız</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Available dates data
            var availableDates = @Html.Raw(Json.Serialize(availableDates));
            var selectedDate = null;
            var selectedTime = null;

            // Tarih seçildiğinde saatleri yükle
            $('#dateSelect').change(function() {
                var selectedDateStr = $(this).val();
                var timeSelect = $('#timeSelect');

                if (!selectedDateStr) {
                    timeSelect.prop('disabled', true);
                    timeSelect.html('<option value="">Önce tarih seçin</option>');
                    $('#continueButton').prop('disabled', true);
                    updateSelectedDateTime();
                    return;
                }

                // Seçilen tarihi bul
                selectedDate = availableDates.find(function(d) {
                    return d.date === selectedDateStr;
                });

                if (selectedDate && selectedDate.availableSlots && selectedDate.availableSlots.length > 0) {
                    timeSelect.prop('disabled', false);
                    timeSelect.html('<option value="">Saat seçin</option>');

                    // Saatleri doldur
                    selectedDate.availableSlots.forEach(function(slot) {
                        var startTime = formatTime(slot.startTime);
                        var endTime = formatTime(slot.endTime);
                        timeSelect.append('<option value="' + slot.startTime + '">' + startTime + ' - ' + endTime + '</option>');
                    });
                } else {
                    timeSelect.prop('disabled', true);
                    timeSelect.html('<option value="">Bu tarihte müsait saat yok</option>');
                }

                $('#continueButton').prop('disabled', true);
                updateSelectedDateTime();
            });

            // Saat seçildiğinde
            $('#timeSelect').change(function() {
                selectedTime = $(this).val();
                if (selectedDate && selectedTime) {
                    $('#continueButton').prop('disabled', false);
                }
                updateSelectedDateTime();
            });

            // Seçilen tarih/saati güncelle
            function updateSelectedDateTime() {
                if (selectedDate && selectedTime) {
                    var dateTime = new Date(selectedDate.date + 'T' + selectedTime);
                    var formattedDate = dateTime.toLocaleDateString('tr-TR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    $('#selectedDateTimeText').text(formattedDate);
                    $('#formDateTime').val(dateTime.toISOString());
                } else {
                    $('#selectedDateTimeText').text('Henüz tarih/saat seçmediniz');
                }
            }

            // Saat formatını düzenle
            function formatTime(timeString) {
                var time = new Date('2000-01-01T' + timeString);
                return time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            }

            // Müsaitlik kontrolü
            $('#checkAvailability').click(function() {
                if (!selectedDate || !selectedTime) {
                    alert('Lütfen önce bir tarih ve saat seçin.');
                    return;
                }

                var antrenorId = @ViewBag.AntrenorId;
                var dateTime = selectedDate.date + 'T' + selectedTime + ':00';
                var sureDakika = @hizmet?.SureDakika;

                // Yükleniyor göster
                var resultDiv = $('#availabilityResult');
                resultDiv.removeClass('d-none alert-success alert-danger alert-warning');
                resultDiv.addClass('alert-warning');
                resultDiv.html('<i class="fas fa-spinner fa-spin"></i> Müsaitlik kontrol ediliyor...');

                // API çağrısı
                $.get('/UyeRandevu/CheckAvailability', {
                    antrenorId: antrenorId,
                    randevuTarihi: dateTime,
                    sureDakika: sureDakika
                }, function(response) {
                    resultDiv.removeClass('alert-warning');

                    if (response.Musait) {
                        resultDiv.addClass('alert-success');
                        resultDiv.html('<i class="fas fa-check-circle"></i> Antrenör müsait! Randevu oluşturabilirsiniz.');
                    } else {
                        resultDiv.addClass('alert-danger');
                        var html = '<i class="fas fa-exclamation-circle"></i> Antrenör müsait değil. ';

                        if (response.CakisanRandevular && response.CakisanRandevular.length > 0) {
                            html += 'Çakışan randevu: ' + response.CakisanRandevular[0].Hizmet +
                                   ' (' + response.CakisanRandevular[0].Baslangic + ' - ' +
                                   response.CakisanRandevular[0].Bitis + ')';
                        }

                        resultDiv.html(html);
                    }
                }).fail(function() {
                    resultDiv.removeClass('alert-warning');
                    resultDiv.addClass('alert-danger');
                    resultDiv.html('<i class="fas fa-times-circle"></i> Müsaitlik kontrolü sırasında hata oluştu.');
                });
            });

            // DEVAM ET butonu
            $('#continueButton').click(function() {
                if (!selectedDate || !selectedTime) {
                    alert('Lütfen bir tarih ve saat seçin.');
                    return;
                }

                // Not'u forma ekle
                $('#formNot').val($('#not').val());

                // Formu göster (debug için)
                console.log('Form gönderiliyor:', {
                    AntrenorId: @ViewBag.AntrenorId,
                    HizmetId: @ViewBag.HizmetId,
                    RandevuTarihi: $('#formDateTime').val(),
                    Not: $('#not').val()
                });

                // Butonu yükleniyor durumuna getir
                $(this).html('<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...');
                $(this).prop('disabled', true);

                // Formu submit et
                $('#appointmentForm').submit();
            });

            // Not değiştiğinde
            $('#not').on('input', function() {
                $('#formNot').val($(this).val());
            });
        });
    </script>
}