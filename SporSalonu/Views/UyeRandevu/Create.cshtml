@model YeniSalon.Models.Randevu

@{
    ViewData["Title"] = "Yeni Randevu Oluştur";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">Yeni Randevu Oluştur</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Create" id="randevuForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        
                        <input type="hidden" asp-for="KullaniciId" value="@ViewBag.userId" class="form-control" />

                        <!-- Antrenör Seçimi -->
                        <div class="mb-3">
                            <label asp-for="AntrenorId" class="form-label"></label>
                            <select asp-for="AntrenorId" class="form-select" id="antrenorSelect" required>
                                <option value="">Antrenör Seçiniz</option>
                                @foreach (var item in (List<SelectListItem>)ViewBag.Antrenorler)
                                {
                                    <option value="@item.Value" data-name="@item.Text">@item.Text</option>
                                }
                            </select>
                            <span asp-validation-for="AntrenorId" class="text-danger"></span>
                        </div>

                        <!-- Hizmet Seçimi -->
                        <div class="mb-3">
                            <label asp-for="HizmetId" class="form-label"></label>
                            <select asp-for="HizmetId" class="form-select" id="hizmetSelect" required>
                                <option value="">Hizmet Seçiniz</option>
                                @foreach (var item in (List<SelectListItem>)ViewBag.Hizmetler)
                                {
                                    <option value="@item.Value" data-sure="@item.Text.Split('-').Last().Trim().Split(' ')[0]"
                                            data-name="@item.Text">@item.Text</option>
                                }
                            </select>
                            <span asp-validation-for="HizmetId" class="text-danger"></span>
                        </div>

                        <!-- Tarih Seçimi (SADECE MÜSAİT TARİHLER GELECEK) -->
                        <div class="mb-3">
                            <label class="form-label">Tarih Seçiniz</label>
                            <select id="dateSelect" class="form-select" disabled required>
                                <option value="">Önce antrenör ve hizmet seçin</option>
                            </select>
                            <small class="text-muted">Sadece antrenörün müsait olduğu tarihler gösterilmektedir</small>
                            <div id="dateLoading" class="text-primary mt-1" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Tarihler yükleniyor...
                            </div>
                        </div>

                        <!-- Saat Seçimi (SADECE MÜSAİT SAATLER GELECEK) -->
                        <div class="mb-3">
                            <label class="form-label">Saat Seçiniz</label>
                            <select id="timeSelect" class="form-select" disabled required>
                                <option value="">Önce tarih seçin</option>
                            </select>
                            <small class="text-muted">Sadece müsait saat aralıkları gösterilmektedir</small>
                            <div id="timeLoading" class="text-primary mt-1" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Saatler yükleniyor...
                            </div>
                        </div>

                        <!-- Hidden input for RandevuTarihi -->
                        <input type="hidden" asp-for="RandevuTarihi" id="randevuTarihiHidden" />

                        <!-- Seçilen Randevu Bilgisi -->
                        <div id="selectedAppointment" class="alert alert-info" style="display: none;">
                            <h6>Seçilen Randevu:</h6>
                            <p id="selectedDateTimeText">-</p>
                            <p><strong>Antrenör:</strong> <span id="selectedAntrenorText">-</span></p>
                            <p><strong>Hizmet:</strong> <span id="selectedHizmetText">-</span></p>
                            <p><strong>Süre:</strong> <span id="selectedSureText">-</span> dakika</p>
                        </div>

                        <!-- Müsaitlik Durumu -->
                        <div id="availabilityStatus" class="alert" style="display: none;">
                            <i class="fas fa-info-circle"></i> <span id="availabilityText"></span>
                        </div>

                        <!-- Not -->
                        <div class="mb-3">
                            <label asp-for="Not" class="form-label"></label>
                            <textarea asp-for="Not" class="form-control" rows="3" placeholder="Randevu için özel notunuz..."></textarea>
                            <span asp-validation-for="Not" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                                <i class="fas fa-save"></i> Randevu Talebi Oluştur
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times"></i> İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bilgilendirme -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5><i class="fas fa-info-circle text-primary"></i> Bilgilendirme:</h5>
                    <ul class="mb-0">
                        <li>Sadece antrenörün <strong>müsait olduğu tarih ve saatler</strong> gösterilmektedir</li>
                        <li>Randevular antrenör onayından sonra kesinleşir</li>
                        <li>İptaller için en az 2 saat önce bildirim yapınız</li>
                        <li>Randevu saatinizden 1 saat önce hatırlatma mesajı alacaksınız</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        #selectedAppointment {
            border-left: 4px solid #0d6efd;
        }

        #availabilityStatus.success {
            background-color: #d1e7dd;
            border-color: #badbcc;
            color: #0f5132;
        }

        #availabilityStatus.warning {
            background-color: #fff3cd;
            border-color: #ffecb5;
            color: #664d03;
        }

        #submitBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

        // Create.cshtml - GÜNCELLENMİŞ JavaScript
    <script>
        $(document).ready(function() {
            let selectedAntrenorId = null;
            let selectedHizmetId = null;
            let selectedDate = null;
            let selectedTime = null;
            let selectedDateTime = null;
            let hizmetSure = 60;

            // Antrenör seçildiğinde
            $('#antrenorSelect').change(function() {
                selectedAntrenorId = $(this).val();
                console.log('Antrenör ID:', selectedAntrenorId);
                updateDateSelection();
            });

            // Hizmet seçildiğinde
            $('#hizmetSelect').change(function() {
                selectedHizmetId = $(this).val();
                console.log('Hizmet ID:', selectedHizmetId);

                // Hizmet süresini al
                var selectedOption = $(this).find('option:selected');
                var sureText = selectedOption.data('sure');
                hizmetSure = sureText ? parseInt(sureText) : 60;

                console.log('Hizmet süresi:', hizmetSure);

                // Hizmet bilgisini göster
                var hizmetText = selectedOption.data('name') || selectedOption.text();
                $('#selectedHizmetText').text(hizmetText);
                $('#selectedSureText').text(hizmetSure);

                updateDateSelection();
            });

            // Tarih seçildiğinde
            $('#dateSelect').change(function() {
                selectedDate = $(this).val();
                console.log('Seçilen tarih:', selectedDate);
                if (selectedDate && selectedAntrenorId && selectedHizmetId) {
                    loadAvailableTimes();
                } else {
                    $('#timeSelect').prop('disabled', true).html('<option value="">Önce tarih seçin</option>');
                    resetSelection();
                }
            });

            // Saat seçildiğinde
            $('#timeSelect').change(function() {
                selectedTime = $(this).val();
                console.log('Seçilen saat:', selectedTime);
                if (selectedTime) {
                    var timeOption = $(this).find('option:selected');
                    var dateTimeStr = timeOption.data('datetime') || (selectedDate + 'T' + selectedTime + ':00');

                    selectedDateTime = new Date(dateTimeStr);

                    console.log('Seçilen tarih-saat:', selectedDateTime);

                    // Hidden input'a değeri ata
                    $('#randevuTarihiHidden').val(selectedDateTime.toISOString());

                    // Seçimi göster
                    updateSelectedAppointment();

                    // Müsaitlik kontrolü yap
                    checkAvailability();

                    // Submit butonunu aktif et
                    $('#submitBtn').prop('disabled', false);
                } else {
                    resetSelection();
                    $('#submitBtn').prop('disabled', true);
                }
            });

            // Tarihleri yükle
            function updateDateSelection() {
                if (selectedAntrenorId && selectedHizmetId) {
                    // Antrenör bilgisini göster
                    var antrenorOption = $('#antrenorSelect option:selected');
                    $('#selectedAntrenorText').text(antrenorOption.data('name') || antrenorOption.text());

                    // Tarihleri yükle
                    loadAvailableDates();
                } else {
                    $('#dateSelect').prop('disabled', true).html('<option value="">Önce antrenör ve hizmet seçin</option>');
                    $('#timeSelect').prop('disabled', true).html('<option value="">Önce tarih seçin</option>');
                    resetSelection();
                }
            }

            // Müsait tarihleri yükle
            function loadAvailableDates() {
                console.log('Müsait tarihler yükleniyor...');
                $('#dateLoading').show();
                $('#dateSelect').prop('disabled', true);

                $.ajax({
                    url: '/UyeRandevu/GetAvailableDates',
                    type: 'GET',
                    data: {
                        antrenorId: selectedAntrenorId,
                        hizmetId: selectedHizmetId
                    },
                    success: function(response) {
                        console.log('Tarih yanıtı:', response);

                        $('#dateLoading').hide();

                        if (response.success && response.dates && response.dates.length > 0) {
                            var dateSelect = $('#dateSelect');
                            dateSelect.html('<option value="">Tarih Seçiniz</option>');

                            $.each(response.dates, function(index, dateItem) {
                                console.log('Tarih öğesi:', dateItem);
                                // JSON'daki property isimleri küçük harfle geliyor
                                dateSelect.append('<option value="' + dateItem.date + '">' + dateItem.displayText + '</option>');
                            });

                            dateSelect.prop('disabled', false);

                            // Başarı mesajı
                            showAvailabilityStatus(response.dates.length + ' müsait tarih bulundu.', 'success');
                        } else {
                            $('#dateSelect').html('<option value="">Müsait tarih bulunamadı</option>');
                            var message = response.message || 'Önümüzdeki 30 gün içinde müsait tarih bulunamadı.';
                            showAvailabilityStatus(message, 'warning');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Tarih yükleme hatası:', error);
                        $('#dateLoading').hide();
                        $('#dateSelect').html('<option value="">Tarihler yüklenirken hata oluştu</option>');
                        showAvailabilityStatus('Tarihler yüklenirken bir hata oluştu: ' + error, 'warning');
                    }
                });
            }

            // Müsait saatleri yükle
            function loadAvailableTimes() {
                console.log('Müsait saatler yükleniyor...');
                $('#timeLoading').show();
                $('#timeSelect').prop('disabled', true);

                $.ajax({
                    url: '/UyeRandevu/GetAvailableTimes',
                    type: 'GET',
                    data: {
                        antrenorId: selectedAntrenorId,
                        hizmetId: selectedHizmetId,
                        date: selectedDate
                    },
                    success: function(response) {
                        console.log('Saat yanıtı:', response);

                        $('#timeLoading').hide();

                        if (response.success && response.times && response.times.length > 0) {
                            var timeSelect = $('#timeSelect');
                            timeSelect.html('<option value="">Saat Seçiniz</option>');

                            $.each(response.times, function(index, timeItem) {
                                console.log('Saat öğesi:', timeItem);
                                // data-datetime attribute'u ekleyelim
                                timeSelect.append('<option value="' + timeItem.time + '" data-datetime="' + timeItem.dateTime + '">' + timeItem.displayText + '</option>');
                            });

                            timeSelect.prop('disabled', false);

                            showAvailabilityStatus(response.times.length + ' müsait saat aralığı bulundu.', 'success');
                        } else {
                            $('#timeSelect').html('<option value="">Müsait saat bulunamadı</option>');
                            var message = response.message || 'Bu tarihte müsait saat bulunamadı. Lütfen başka bir tarih seçin.';
                            showAvailabilityStatus(message, 'warning');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Saat yükleme hatası:', error);
                        $('#timeLoading').hide();
                        $('#timeSelect').html('<option value="">Saatler yüklenirken hata oluştu</option>');
                        showAvailabilityStatus('Saatler yüklenirken bir hata oluştu: ' + error, 'warning');
                    }
                });
            }

            // Müsaitlik kontrolü yap
                   // Müsaitlik kontrolü yap
        function checkAvailability() {
            if (!selectedDateTime) return;

            console.log('Müsaitlik kontrolü yapılıyor...');
            console.log('Seçilen tarih-saat:', selectedDateTime);
            console.log('Antrenör ID:', selectedAntrenorId);
            console.log('Hizmet süresi:', hizmetSure);

            // DEBUG: Önce randevuları kontrol et
            // $.get('/UyeRandevu/DebugRandevular', {
            //     antrenorId: selectedAntrenorId,
            //     tarih: selectedDateTime.toISOString()
            // }, function(debugResponse) {
            //     console.log('DEBUG - Randevular:', debugResponse);

            //     // DEBUG: Müsaitlik saatlerini kontrol et
            //     $.get('/UyeRandevu/DebugMusaitlikSaatleri', {
            //         antrenorId: selectedAntrenorId,
            //         tarih: selectedDateTime.toISOString()
            //     }, function(musaitlikResponse) {
            //         console.log('DEBUG - Müsaitlik saatleri:', musaitlikResponse);

            //         // Yükleniyor göster
            //         showAvailabilityStatus('<i class="fas fa-spinner fa-spin"></i> Müsaitlik kontrol ediliyor...', 'info');

            //         // Asıl müsaitlik kontrolü
            //         $.ajax({
            //             url: '/UyeRandevu/CheckAvailability',
            //             type: 'GET',
            //             data: {
            //                 antrenorId: selectedAntrenorId,
            //                 randevuTarihi: selectedDateTime.toISOString(),
            //                 sureDakika: hizmetSure
            //             },
            //             success: function(response) {
            //                 console.log('Müsaitlik kontrol yanıtı:', response);

            //                 if (response.Musait) {
            //                     showAvailabilityStatus('<i class="fas fa-check-circle"></i> ✓ Antrenör bu saatte müsait. Randevu oluşturabilirsiniz.', 'success');
            //                     $('#submitBtn').prop('disabled', false);
            //                 } else {
            //                     showAvailabilityStatus('<i class="fas fa-exclamation-triangle"></i> ⚠ ' + response.Mesaj, 'warning');
            //                     $('#submitBtn').prop('disabled', true);
            //                 }
            //             },
            //             error: function(xhr, status, error) {
            //                 console.error('Müsaitlik kontrol hatası:', error);
            //                 showAvailabilityStatus('<i class="fas fa-exclamation-triangle"></i> Müsaitlik kontrolü yapılamadı.', 'warning');
            //             }
            //         });
            //     });
            // });
        }

            // Seçilen randevuyu göster
            function updateSelectedAppointment() {
                var formattedDate = selectedDateTime.toLocaleDateString('tr-TR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                $('#selectedDateTimeText').text(formattedDate);
                $('#selectedAppointment').show();
            }

            // Seçimi sıfırla
            function resetSelection() {
                selectedDate = null;
                selectedTime = null;
                selectedDateTime = null;
                $('#randevuTarihiHidden').val('');
                $('#selectedAppointment').hide();
                $('#submitBtn').prop('disabled', true);
                $('#availabilityStatus').hide();
            }

            // Müsaitlik durumunu göster
            function showAvailabilityStatus(message, type) {
                var statusDiv = $('#availabilityStatus');
                statusDiv.removeClass('success warning info');
                statusDiv.addClass(type);
                statusDiv.html('<i class="fas fa-info-circle"></i> ' + message);
                statusDiv.show();
            }

            // Form gönderilmeden önce son kontrol
            $('#randevuForm').submit(function(e) {
                console.log('Form gönderiliyor...');

                if (!selectedDateTime) {
                    e.preventDefault();
                    alert('Lütfen bir tarih ve saat seçin.');
                    return false;
                }

                if (!$('#randevuTarihiHidden').val()) {
                    e.preventDefault();
                    alert('Randevu tarihi seçilmemiş.');
                    return false;
                }

                // Submit butonunu devre dışı bırak
                $('#submitBtn').html('<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...');
                $('#submitBtn').prop('disabled', true);

                return true;
            });

            // Debug için tüm seçimleri konsola yaz
            window.debugSelection = function() {
                console.log('DEBUG - Seçimler:', {
                    antrenorId: selectedAntrenorId,
                    hizmetId: selectedHizmetId,
                    tarih: selectedDate,
                    saat: selectedTime,
                    dateTime: selectedDateTime,
                    hizmetSure: hizmetSure
                });
            }
        });
    </script>
}
}