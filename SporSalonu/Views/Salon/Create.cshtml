@model YeniSalon.Models.Salon

@{
    ViewData["Title"] = "Yeni Salon Oluştur";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>@ViewData["Title"]
                        </h4>
                        <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Geri Dön
                        </a>
                    </div>
                </div>
                <div class="card-body">

                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <form asp-action="Create" id="createSalonForm">
                        @Html.AntiForgeryToken()

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="SalonAdi" class="form-label required"></label>
                                <input asp-for="SalonAdi" class="form-control" placeholder="Salon adını giriniz" />
                                <span asp-validation-for="SalonAdi" class="text-danger"></span>
                                <div class="form-text">Salonun resmi adı</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="Adres" class="form-label"></label>
                                <textarea asp-for="Adres" class="form-control" rows="3" placeholder="Tam adresi giriniz"></textarea>
                                <span asp-validation-for="Adres" class="text-danger"></span>
                                <div class="form-text">Salonun tam adresi</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Telefon" class="form-label"></label>
                                <input asp-for="Telefon" class="form-control" placeholder="05XX XXX XX XX" />
                                <span asp-validation-for="Telefon" class="text-danger"></span>
                                <div class="form-text">Salon telefon numarası</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label"></label>
                                <input asp-for="Email" class="form-control" placeholder="ornek@salon.com" />
                                <span asp-validation-for="Email" class="text-danger"></span>
                                <div class="form-text">Salon iletişim e-postası</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="AcilisSaati" class="form-label required"></label>
                                <input asp-for="AcilisSaati" type="time" class="form-control" />
                                <span asp-validation-for="AcilisSaati" class="text-danger"></span>
                                <div class="form-text">Salonun açılış saati</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="KapanisSaati" class="form-label required"></label>
                                <input asp-for="KapanisSaati" type="time" class="form-control" />
                                <span asp-validation-for="KapanisSaati" class="text-danger"></span>
                                <div class="form-text">Salonun kapanış saati</div>
                            </div>
                        </div>

                        <!-- API ile oluşturma butonu (isteğe bağlı) -->
                        <div class="card mb-4">
                            <div class="card-body">
                               <button type="button" class="btn btn-outline-info w-100" onclick="createSalonViaAPI()">
                                    <i class="fas fa-save me-1"></i>Oluştur
                                </button>
                                <div id="apiResult" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Form submit işlemi
        $('#createSalonForm').submit(function(e) {
            // Zorunlu alan kontrolleri
            if (!$('#SalonAdi').val()) {
                e.preventDefault();
                toastr.error('Salon adı zorunludur.');
                return false;
            }

            // Saat kontrolleri
            const acilis = $('#AcilisSaati').val();
            const kapanis = $('#KapanisSaati').val();

            if (!acilis || !kapanis) {
                e.preventDefault();
                toastr.error('Açılış ve kapanış saatleri zorunludur.');
                return false;
            }

            if (acilis >= kapanis) {
                e.preventDefault();
                toastr.error('Kapanış saati açılış saatinden sonra olmalıdır.');
                return false;
            }

            return true;
        });

        // API ile salon oluşturma
        function createSalonViaAPI() {
            const salonData = {
                salonAdi: $('#SalonAdi').val(),
                adres: $('#Adres').val(),
                telefon: $('#Telefon').val(),
                email: $('#Email').val(),
                acilisSaati: $('#AcilisSaati').val() + ':00',
                kapanisSaati: $('#KapanisSaati').val() + ':00'
            };

            // Validasyon
            if (!salonData.salonAdi) {
                toastr.error('Salon adı zorunludur.');
                return;
            }

            $('#apiResult').html(`
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-2">API ile oluşturuluyor...</p>
                </div>
            `);

            $.ajax({
                url: '/api/SalonApi',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                data: JSON.stringify(salonData),
                success: function(response) {
                    $('#apiResult').html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Salon API üzerinden başarıyla oluşturuldu!
                            <br><small>Salon ID: ${response.salon.salonId}</small>
                        </div>
                        <div class="mt-2">
                            <a href="/Salon/Details/${response.salon.salonId}" class="btn btn-sm btn-success">
                                <i class="fas fa-eye me-1"></i>Detayları Gör
                            </a>
                            <a href="/Salon/List" class="btn btn-sm btn-primary">
                                <i class="fas fa-list me-1"></i>Listeye Git
                            </a>
                        </div>
                    `);

                    toastr.success(response.message);
                },
                error: function(xhr) {
                    let errorMessage = 'API hatası oluştu.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }

                    $('#apiResult').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${errorMessage}
                        </div>
                    `);

                    toastr.error(errorMessage);
                }
            });
        }

        // Şablon yükleme
        function loadTemplate(type) {
            const templates = {
                'main': {
                    salonAdi: 'Ana Spor Salonu',
                    adres: 'Merkez Mah. Spor Cad. No:1',
                    telefon: '0212 345 67 89',
                    email: 'ana@sporsalonu.com',
                    acilisSaati: '06:00',
                    kapanisSaati: '23:00'
                },
                'pool': {
                    salonAdi: 'Yüzme Havuzu',
                    adres: 'Spor Kompleksi Havuz Binası',
                    telefon: '0212 987 65 43',
                    email: 'havuz@sporsalonu.com',
                    acilisSaati: '07:00',
                    kapanisSaati: '21:00'
                },
                'yoga': {
                    salonAdi: 'Pilates ve Yoga Salonu',
                    adres: 'Studio Binası Kat:2',
                    telefon: '0212 111 22 33',
                    email: 'studio@sporsalonu.com',
                    acilisSaati: '08:00',
                    kapanisSaati: '20:00'
                }
            };

            const template = templates[type];
            if (template) {
                $('#SalonAdi').val(template.salonAdi);
                $('#Adres').val(template.adres);
                $('#Telefon').val(template.telefon);
                $('#Email').val(template.email);
                $('#AcilisSaati').val(template.acilisSaati);
                $('#KapanisSaati').val(template.kapanisSaati);

                toastr.success(`"${template.salonAdi}" şablonu yüklendi.`);
            }
        }

        // Oluştur ve devam et
        function saveAndContinue() {
            // Form submit ediliyor
            $('#createSalonForm').append('<input type="hidden" name="continue" value="true">');
            $('#createSalonForm').submit();
        }

        // Sayfa yüklendiğinde
        $(document).ready(function() {
            // Zaman inputlarına min-max değerleri ekle
            $('#AcilisSaati').attr('min', '00:00').attr('max', '23:59');
            $('#KapanisSaati').attr('min', '00:00').attr('max', '23:59');

            // Telefon input'u için mask
            $('#Telefon').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length > 0) {
                    if (value.length <= 4) {
                        value = value.replace(/(\d{1,4})/, '$1');
                    } else if (value.length <= 7) {
                        value = value.replace(/(\d{4})(\d{1,3})/, '$1 $2');
                    } else {
                        value = value.replace(/(\d{4})(\d{3})(\d{1,4})/, '$1 $2 $3');
                    }
                }
                $(this).val(value);
            });

            // Form alanlarına otomatik tamamlama özelliği
            $('#SalonAdi').on('input', function() {
                const salonAdi = $(this).val();
                if (salonAdi && !$('#Email').val()) {
                    const email = salonAdi.toLowerCase()
                        .replace(/[^a-z0-9]/g, '')
                        .replace(/\s+/g, '') + '@@sporsalonu.com';
                    $('#Email').val(email);
                }
            });
        });
    </script>

    <style>
        .required:after {
            content: " *";
            color: #dc3545;
        }

        .card.border-primary {
            border-width: 2px;
        }

        .card.border-success {
            border-width: 2px;
        }

        .card.border-warning {
            border-width: 2px;
        }

        .form-text {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .btn-group .btn {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
    </style>
}